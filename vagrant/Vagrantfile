# Vagrantfile API/syntax version. Don't touch unless you know what you're doing!
VAGRANTFILE_API_VERSION = "2"

# Require colors..
require './color'

# Lets get this party started
if !ARGV.include?("halt") && !ARGV.include?("destroy")
    puts "Welcome, developer! ðŸ˜Ž".green
    puts "Human contact possible @ https://github.com/orgs/UKMNorge/teams/developers".green
end

# Global vars
$localNFSpath = "#{Dir.pwd}/"
$boxNames = []

# Files we kinda need
require './filesystem'      # File system functions
require './dependencies'    # Vagrant plugin dependencies
require './boxconfig'       # Different vagrant-box configs
require './utils'           # VM conf utilities

# Configure vagrant!
Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|
    # Every Vagrant virtual environment requires a box to build off of.
    config.vm.box = "ubuntu/bionic64"
  
    # Share the salt config with the guest
    config.vm.synced_folder "salt", "/srv/salt/"
    config.vm.synced_folder "pillar", "/srv/pillar"

    # Setup host manager
    config.hostmanager.enabled = true
    config.hostmanager.manage_host = true
    config.hostmanager.manage_guest = true
    config.hostmanager.include_offline = true   # So every box knows each other, even if currently offline

    config.vm.provider :virtualbox do |vb|
        vb.customize ["modifyvm", :id, "--memory", $boxConf['main'][:memory]]
    end

    ## main MAIN SERVER (UKM.no)
    config.vm.define "main", primary: true do |main|
        commonConf('main', main)

        # Share wordpress folders
        share(main, 'main/plugins', '/var/www/wordpress/wp-content/plugins/')
        share(main, 'main/themes', '/var/www/wordpress/wp-content/themes/')
        share(main, 'main/ukmlib', '/etc/php-includes/UKM/')
        shareSubdomains('main', main, config);
        
        # Hostname conf
        main.vm.hostname = "ukm.dev"
        hostname_aliases = Array.new
        
        # Provision (salt-stack)
        doProvision('main',main)
    end

    ## LITE main SERVER (for project fun)
    config.vm.define "lite" do |lite|
        commonConf('lite', lite)

        hostname_aliases = Array.new
        hostname_aliases << 'ukm.dev'

        # Share before provision, in case host has existing files
        shareSubdomains('lite', lite, config);
        share(lite, 'lite/www', '/var/www/lite/')        
        share(lite, 'lite/ukmlib', '/etc/php-includes/UKM/')
        
        # Provision (salt-stack)
        doProvision('lite',lite)

        lite.hostmanager.aliases = hostname_aliases
    end
end